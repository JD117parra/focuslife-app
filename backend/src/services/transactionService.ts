import { prisma } from '../config/database';
import {
  CreateTransactionDto,
  UpdateTransactionDto,
  TransactionResponse,
  CreateCategoryDto,
  CategoryResponse,
} from '../types';

export class TransactionService {
  // Obtener todas las transacciones de un usuario
  static async getUserTransactions(
    userId: string,
    filters?: {
      type?: 'INCOME' | 'EXPENSE';
      categoryId?: string;
      startDate?: string;
      endDate?: string;
    }
  ): Promise<TransactionResponse[]> {
    const whereClause: any = { userId };

    // Aplicar filtros
    if (filters?.type) {
      whereClause.type = filters.type;
    }

    if (filters?.categoryId) {
      whereClause.categoryId = filters.categoryId;
    }

    if (filters?.startDate || filters?.endDate) {
      whereClause.date = {};
      if (filters.startDate) whereClause.date.gte = new Date(filters.startDate);
      if (filters.endDate) whereClause.date.lte = new Date(filters.endDate);
    }

    const transactions = await prisma.transaction.findMany({
      where: whereClause,
      orderBy: [{ date: 'desc' }, { createdAt: 'desc' }],
      include: {
        category: {
          select: {
            id: true,
            name: true,
            color: true,
          },
        },
      },
    });

    return transactions;
  }

  // Obtener una transacci√≥n espec√≠fica por ID
  static async getTransactionById(
    transactionId: string,
    userId: string
  ): Promise<TransactionResponse | null> {
    const transaction = await prisma.transaction.findFirst({
      where: {
        id: transactionId,
        userId,
      },
      include: {
        category: {
          select: {
            id: true,
            name: true,
            color: true,
          },
        },
      },
    });

    return transaction;
  }

  // Crear nueva transacci√≥n
  static async createTransaction(
    userId: string,
    transactionData: CreateTransactionDto
  ): Promise<TransactionResponse> {
    const { amount, description, type, categoryId, date } = transactionData;

    // Para gastos, asegurar que el monto sea positivo (se maneja en el frontend)
    const finalAmount = type === 'EXPENSE' ? Math.abs(amount) : amount;

    const transaction = await prisma.transaction.create({
      data: {
        amount: finalAmount,
        description,
        type,
        categoryId,
        userId,
        date: date ? new Date(date) : new Date(),
      },
      include: {
        category: {
          select: {
            id: true,
            name: true,
            color: true,
          },
        },
      },
    });

    return transaction;
  }

  // Actualizar transacci√≥n
  static async updateTransaction(
    transactionId: string,
    userId: string,
    transactionData: UpdateTransactionDto
  ): Promise<TransactionResponse | null> {
    // Verificar que la transacci√≥n existe y pertenece al usuario
    const existingTransaction = await prisma.transaction.findFirst({
      where: { id: transactionId, userId },
    });

    if (!existingTransaction) {
      throw new Error(
        'Transaction not found or you do not have permission to update it'
      );
    }

    // Procesar el monto si se est√° actualizando
    const updateData: any = { ...transactionData };
    if (updateData.amount !== undefined && updateData.type) {
      updateData.amount =
        updateData.type === 'EXPENSE'
          ? Math.abs(updateData.amount)
          : updateData.amount;
    }

    if (updateData.date) {
      updateData.date = new Date(updateData.date);
    }

    const updatedTransaction = await prisma.transaction.update({
      where: { id: transactionId },
      data: {
        ...updateData,
        updatedAt: new Date(),
      },
      include: {
        category: {
          select: {
            id: true,
            name: true,
            color: true,
          },
        },
      },
    });

    return updatedTransaction;
  }

  // Eliminar transacci√≥n
  static async deleteTransaction(
    transactionId: string,
    userId: string
  ): Promise<boolean> {
    // Verificar que la transacci√≥n existe y pertenece al usuario
    const existingTransaction = await prisma.transaction.findFirst({
      where: { id: transactionId, userId },
    });

    if (!existingTransaction) {
      throw new Error(
        'Transaction not found or you do not have permission to delete it'
      );
    }

    await prisma.transaction.delete({
      where: { id: transactionId },
    });

    return true;
  }

  // Obtener estad√≠sticas financieras del usuario
  static async getFinancialStats(
    userId: string,
    period?: {
      startDate?: string;
      endDate?: string;
    }
  ) {
    const whereClause: any = { userId };

    if (period?.startDate || period?.endDate) {
      whereClause.date = {};
      if (period.startDate) whereClause.date.gte = new Date(period.startDate);
      if (period.endDate) whereClause.date.lte = new Date(period.endDate);
    }

    // Calcular totales por tipo
    const incomeStats = await prisma.transaction.aggregate({
      where: { ...whereClause, type: 'INCOME' },
      _sum: { amount: true },
      _count: { id: true },
    });

    const expenseStats = await prisma.transaction.aggregate({
      where: { ...whereClause, type: 'EXPENSE' },
      _sum: { amount: true },
      _count: { id: true },
    });

    const totalIncome = incomeStats._sum.amount || 0;
    const totalExpenses = expenseStats._sum.amount || 0;
    const balance = totalIncome - totalExpenses;

    // Obtener transacciones por categor√≠a
    const expensesByCategory = await prisma.transaction.groupBy({
      by: ['categoryId'],
      where: { ...whereClause, type: 'EXPENSE' },
      _sum: { amount: true },
      _count: { id: true },
    });

    return {
      balance,
      totalIncome,
      totalExpenses,
      incomeTransactions: incomeStats._count.id,
      expenseTransactions: expenseStats._count.id,
      totalTransactions: incomeStats._count.id + expenseStats._count.id,
      expensesByCategory,
    };
  }

  // Obtener resumen del mes actual
  static async getCurrentMonthSummary(userId: string) {
    const now = new Date();
    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
    const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);

    return this.getFinancialStats(userId, {
      startDate: startOfMonth.toISOString(),
      endDate: endOfMonth.toISOString(),
    });
  }

  // === M√âTODOS PARA CATEGOR√çAS ===

  // Obtener todas las categor√≠as de finanzas
  static async getFinanceCategories(): Promise<CategoryResponse[]> {
    const categories = await prisma.category.findMany({
      where: { type: 'FINANCE' },
      orderBy: { name: 'asc' },
    });

    return categories;
  }

  // Crear nueva categor√≠a de finanzas
  static async createCategory(
    categoryData: CreateCategoryDto
  ): Promise<CategoryResponse> {
    const category = await prisma.category.create({
      data: {
        ...categoryData,
        type: 'FINANCE',
      },
    });

    return category;
  }

  // Crear categor√≠as por defecto para un usuario (llamar al registrarse)
  static async createDefaultCategories(): Promise<void> {
    const defaultCategories = [
      // Categor√≠as de ingresos - EXPANDIDAS (24 opciones)
      { name: 'Salario', type: 'FINANCE', color: '#10b981', icon: 'üí∞' },
      { name: 'Freelance', type: 'FINANCE', color: '#3b82f6', icon: 'üíª' },
      { name: 'Inversiones', type: 'FINANCE', color: '#8b5cf6', icon: 'üìà' },
      { name: 'Bonos', type: 'FINANCE', color: '#f59e0b', icon: 'üéÅ' },
      { name: 'Comisiones', type: 'FINANCE', color: '#ef4444', icon: 'üíº' },
      { name: 'Ventas', type: 'FINANCE', color: '#84cc16', icon: 'üõí' },
      { name: 'Alquiler', type: 'FINANCE', color: '#6366f1', icon: 'üè†' },
      { name: 'Dividendos', type: 'FINANCE', color: '#8b5cf6', icon: 'üìä' },
      { name: 'Regalos', type: 'FINANCE', color: '#ec4899', icon: 'üéÅ' },
      { name: 'Propinas', type: 'FINANCE', color: '#f97316', icon: 'üíµ' },
      { name: 'Reembolsos', type: 'FINANCE', color: '#06b6d4', icon: 'üí≥' },
      { name: 'Negocios', type: 'FINANCE', color: '#10b981', icon: 'üè¢' },
      { name: 'Pensi√≥n', type: 'FINANCE', color: '#64748b', icon: 'üë¥' },
      { name: 'Becas', type: 'FINANCE', color: '#3b82f6', icon: 'üéì' },
      { name: 'Trabajo extra', type: 'FINANCE', color: '#f59e0b', icon: '‚è∞' },
      { name: 'Otros ingresos', type: 'FINANCE', color: '#06b6d4', icon: 'üíé' },
      // NUEVAS CATEGOR√çAS DE INGRESOS
      { name: 'Consultor√≠as', type: 'FINANCE', color: '#16a34a', icon: 'ü§ù' },
      { name: 'Cashback', type: 'FINANCE', color: '#0ea5e9', icon: 'üí∏' },
      { name: 'Rifas', type: 'FINANCE', color: '#d946ef', icon: 'üé≤' },
      { name: 'Intereses', type: 'FINANCE', color: '#7c3aed', icon: 'üè¶' },
      { name: 'Seguros', type: 'FINANCE', color: '#dc2626', icon: 'üõ°Ô∏è' },
      { name: 'Herencias', type: 'FINANCE', color: '#65a30d', icon: 'üë¥' },
      { name: 'Pr√©stamos', type: 'FINANCE', color: '#ea580c', icon: 'üí∞' },
      { name: 'Agricultura', type: 'FINANCE', color: '#84cc16', icon: 'üåæ' },

      // Categor√≠as de gastos - EXPANDIDAS (27 opciones)
      { name: 'Alimentaci√≥n', type: 'FINANCE', color: '#f59e0b', icon: 'üçΩÔ∏è' },
      { name: 'Transporte', type: 'FINANCE', color: '#ef4444', icon: 'üöó' },
      {
        name: 'Entretenimiento',
        type: 'FINANCE',
        color: '#ec4899',
        icon: 'üé¨',
      },
      { name: 'Salud', type: 'FINANCE', color: '#84cc16', icon: 'üè•' },
      { name: 'Educaci√≥n', type: 'FINANCE', color: '#6366f1', icon: 'üìö' },
      { name: 'Hogar', type: 'FINANCE', color: '#8b5cf6', icon: 'üè†' },
      { name: 'Ropa', type: 'FINANCE', color: '#d946ef', icon: 'üëï' },
      { name: 'Servicios', type: 'FINANCE', color: '#06b6d4', icon: 'üîå' },
      { name: 'Seguros', type: 'FINANCE', color: '#64748b', icon: 'üõ°Ô∏è' },
      { name: 'Impuestos', type: 'FINANCE', color: '#dc2626', icon: 'üìã' },
      { name: 'Belleza', type: 'FINANCE', color: '#f97316', icon: 'üíÑ' },
      { name: 'Mascotas', type: 'FINANCE', color: '#10b981', icon: 'üêï' },
      { name: 'Regalos', type: 'FINANCE', color: '#ec4899', icon: 'üéÅ' },
      { name: 'Viajes', type: 'FINANCE', color: '#8b5cf6', icon: '‚úàÔ∏è' },
      { name: 'Suscripciones', type: 'FINANCE', color: '#6366f1', icon: 'üì±' },
      { name: 'Trabajo', type: 'FINANCE', color: '#64748b', icon: 'üíº' },
      { name: 'Pr√©stamos', type: 'FINANCE', color: '#ef4444', icon: 'üí≥' },
      { name: 'Otros gastos', type: 'FINANCE', color: '#64748b', icon: 'üì¶' },
      // NUEVAS CATEGOR√çAS DE GASTOS
      { name: 'Gasolina', type: 'FINANCE', color: '#dc2626', icon: '‚õΩ' },
      { name: 'Farmacia', type: 'FINANCE', color: '#16a34a', icon: 'üíä' },
      { name: 'Gimnasio', type: 'FINANCE', color: '#0ea5e9', icon: 'üí™' },
      { name: 'Caf√©', type: 'FINANCE', color: '#92400e', icon: '‚òï' },
      { name: 'Libros', type: 'FINANCE', color: '#7c3aed', icon: 'üìñ' },
      { name: 'Tecnolog√≠a', type: 'FINANCE', color: '#1f2937', icon: 'üíª' },
      { name: 'Streaming', type: 'FINANCE', color: '#db2777', icon: 'üì∫' },
      { name: 'Donaciones', type: 'FINANCE', color: '#059669', icon: 'ü§≤' },
      { name: 'Multas', type: 'FINANCE', color: '#dc2626', icon: 'üö´' },
    ];

    for (const category of defaultCategories) {
      try {
        // Verificar si la categor√≠a ya existe antes de crearla
        const existingCategory = await prisma.category.findFirst({
          where: {
            name: category.name,
            type: 'FINANCE',
          },
        });

        if (!existingCategory) {
          await prisma.category.create({ data: category });
          console.log(`‚úÖ Categor√≠a creada: ${category.name}`);
        } else {
          console.log(`‚ÑπÔ∏è Categor√≠a ya existe: ${category.name}`);
        }
      } catch (error) {
        console.log(`‚ö†Ô∏è Error creando categor√≠a ${category.name}:`, error);
      }
    }
  }
}
